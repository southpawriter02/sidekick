# v1.2.2 — Inline Diff Preview for Agent Edits

**Released:** 2026-02-07

## Summary

Agent code changes now generate unified diffs before application. Users can
inspect hunks, cherry-pick individual changes, and approve or reject edits.
A new **Approval Policy** setting controls when diffs are shown.

## New Features

### Diff Preview System

- LCS-based diff generation with configurable context lines
- Hunk-level granularity — accept, reject, or cherry-pick individual hunks
- Unified diff formatting for display (`--- a/file`, `+++ b/file`, `@@` hunks)
- Partial approval merges only accepted hunks into the original content
- New file / delete file detection with appropriate diff output

### Approval Policy Setting

| Policy | Behavior |
|---|---|
| **Always Proceed** | Apply changes immediately, no diff shown |
| **Agent Decides** | Auto-apply non-destructive; show diff for destructive ops |
| **Request Review** | Always show diff and wait for user decision |

Setting persisted in `sidekick.xml` via `SidekickSettings.agentApprovalPolicy`.
Default: `Agent Decides`.

### Agent Integration

- `AgentExecutor.handleDiffPreview()` intercepts `write_file` / `edit_file`
  before execution and checks the approval policy
- `DiffReviewRequested` event emitted to the UI when review is needed
- `submitDiffReviewDecision()` API for the UI to return the user's choice
- `getPendingReviews()` lists all outstanding review requests

## Files Changed

| File | Change |
|---|---|
| `DiffPreviewModels.kt` | **NEW** — `ApprovalPolicy`, `DiffHunk`, `FileChange`, review models |
| `DiffPreviewService.kt` | **NEW** — Diff generation, cherry-pick merge, formatting |
| `SidekickSettings.kt` | Added `agentApprovalPolicy` to persistent state |
| `AgentTaskModels.kt` | Added `DiffReviewRequested` event to `TaskEvent` |
| `AgentExecutor.kt` | Integrated diff preview, review submission, pending queries |
| `DiffPreviewServiceTest.kt` | **NEW** — 17 unit tests |
| `DiffPreviewModelsTest.kt` | **NEW** — 18 unit tests |
